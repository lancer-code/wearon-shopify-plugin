<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Desktop Shopify PDP + Floating WearOn Fit</title>
  <style>
    :root {
      --page: #f2f1ec;
      --surface: #ffffff;
      --line: #e3e2db;
      --ink: #141516;
      --muted: #6b6f73;
      --brand: #0f766e;
      --brand-dark: #115e59;
      --shadow: 0 14px 32px rgba(10, 12, 14, 0.14);
      --space-1: 8px;
      --space-2: 12px;
      --space-3: 16px;
      --space-4: 20px;
      --space-5: 24px;
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background:
        radial-gradient(1200px 520px at 100% -20%, #ffe7bd 0%, transparent 70%),
        var(--page);
      color: var(--ink);
      font-family: "Sora", "Avenir Next", "Segoe UI", sans-serif;
    }

    button {
      font: inherit;
      cursor: pointer;
      min-height: 44px;
    }

    button:focus-visible {
      outline: 3px solid #1d4ed8;
      outline-offset: 2px;
    }

    .site-header {
      border-bottom: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .site-header-inner {
      width: min(1280px, calc(100% - 40px));
      margin: 0 auto;
      height: 68px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .logo {
      margin: 0;
      font-size: 0.86rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 700;
      color: #44504b;
    }

    .nav {
      display: flex;
      gap: 20px;
      color: #49514f;
      font-size: 0.9rem;
    }

    .nav span { cursor: default; }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-icon {
      min-width: 38px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fff;
      font-weight: 700;
    }

    .desktop-shell {
      width: min(1280px, calc(100% - 40px));
      margin: 26px auto 120px;
    }

    .breadcrumbs {
      display: flex;
      gap: 10px;
      color: #6a716e;
      font-size: 0.82rem;
      margin-bottom: 16px;
    }

    .product-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(340px, 460px);
      gap: 26px;
      align-items: start;
    }

    .gallery {
      display: grid;
      gap: 14px;
    }

    .hero-image {
      border: 1px solid var(--line);
      border-radius: 18px;
      aspect-ratio: 4 / 5;
      background: linear-gradient(160deg, #ece5d6 0%, #f8f6ef 45%, #deefe8 100%);
      position: relative;
      overflow: hidden;
      display: grid;
      place-items: center;
      text-align: center;
      color: #38544d;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 0.82rem;
      font-weight: 700;
    }

    .hero-image::after {
      content: "Desktop product image";
      position: absolute;
      inset: auto 0 16px 0;
      text-align: center;
      color: #60706a;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .thumbs {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }

    .thumb {
      border: 1px solid var(--line);
      border-radius: 12px;
      aspect-ratio: 1 / 1;
      background: linear-gradient(160deg, #f3f0e7 0%, #e5f1ec 100%);
    }

    .thumb.active {
      border-color: #0f766e;
      box-shadow: inset 0 0 0 1px #0f766e;
    }

    .product-panel {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: #fff;
      padding: 20px;
      display: grid;
      gap: 18px;
      position: sticky;
      top: 92px;
      box-shadow: 0 8px 22px rgba(16, 22, 18, 0.06);
    }

    .eyebrow {
      margin: 0;
      color: #60706a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.76rem;
      font-weight: 700;
    }

    .title {
      margin: 6px 0 0;
      font-size: 1.48rem;
      line-height: 1.28;
      letter-spacing: 0.01em;
    }

    .price-row {
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .price {
      font-size: 1.34rem;
      font-weight: 700;
    }

    .compare {
      color: var(--muted);
      text-decoration: line-through;
    }

    .badge {
      margin-left: auto;
      border: 1px solid #aad8cf;
      background: #e9f7f4;
      color: #0f5c55;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.74rem;
      font-weight: 700;
    }

    .group-label {
      margin: 0 0 10px;
      color: #60706a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.76rem;
      font-weight: 700;
    }

    .swatches,
    .sizes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .swatch {
      width: 30px;
      height: 30px;
      border: 2px solid transparent;
      border-radius: 999px;
      min-height: 30px;
    }

    .swatch.active { border-color: #14181a; }

    .size {
      min-width: 48px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      color: #182120;
      font-weight: 600;
    }

    .size.active {
      border-color: #0f766e;
      color: #0f766e;
      background: #ecf9f7;
    }

    .ctas {
      display: grid;
      gap: 10px;
    }

    .cta {
      border: 0;
      border-radius: 12px;
      font-size: 0.96rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .cta.primary { background: #0f172a; color: #fff; }
    .cta.secondary { background: #f59e0b; color: #161d24; }

    .accordion {
      border-top: 1px solid var(--line);
      display: grid;
    }

    .accordion-item {
      min-height: 52px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.92rem;
      font-weight: 600;
      color: #293130;
    }

    .wearon-fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 40;
      border: 0;
      border-radius: 999px;
      min-width: 62px;
      height: 58px;
      padding: 0 16px;
      background: linear-gradient(150deg, var(--brand), var(--brand-dark));
      color: #fff;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
    }

    .fab-hint {
      position: fixed;
      right: 18px;
      bottom: 86px;
      z-index: 39;
      width: 280px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      box-shadow: var(--shadow);
      padding: 10px 10px 12px;
      opacity: 0;
      transform: translateY(6px) scale(0.98);
      transition: opacity 180ms ease, transform 180ms ease;
      pointer-events: none;
    }

    .fab-hint.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .fab-hint::after {
      content: "";
      position: absolute;
      right: 18px;
      bottom: -8px;
      width: 14px;
      height: 14px;
      background: #fff;
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      transform: rotate(45deg);
    }

    .fab-hint-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .fab-hint-title {
      margin: 0;
      font-size: 0.76rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 700;
    }

    .fab-hint-close {
      min-width: 30px;
      min-height: 30px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: #232a2f;
      font-weight: 700;
      line-height: 1;
    }

    .fab-hint-image {
      margin-top: 8px;
      border: 1px solid #cfe0da;
      border-radius: 10px;
      aspect-ratio: 16 / 9;
      background: linear-gradient(155deg, #d8eee8 0%, #f7f3e7 100%);
      display: grid;
      place-items: center;
      text-align: center;
      padding: 8px;
      color: #2e5a52;
      font-size: 0.68rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .fab-hint-text {
      margin: 8px 0 0;
      min-height: 38px;
      font-size: 0.84rem;
      color: #2e3a36;
      line-height: 1.42;
    }

    .fab-hint-actions {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .fab-hint-try,
    .fab-hint-dismiss {
      min-height: 40px;
      border-radius: 10px;
      font-size: 0.82rem;
      font-weight: 700;
    }

    .fab-hint-try {
      border: 0;
      background: linear-gradient(140deg, var(--brand), var(--brand-dark));
      color: #fff;
    }

    .fab-hint-dismiss {
      border: 1px solid var(--line);
      background: #fff;
      color: #1d2528;
    }

    .fit-backdrop {
      position: fixed;
      inset: 0;
      z-index: 44;
      background: rgba(10, 14, 17, 0.46);
      opacity: 0;
      transition: opacity 220ms ease;
    }

    .fit-backdrop.open { opacity: 1; }

    .fit-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      width: min(920px, calc(100vw - 48px));
      max-height: calc(100vh - 48px);
      z-index: 45;
      border: 1px solid var(--line);
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 18px 40px rgba(10, 14, 17, 0.24);
      display: grid;
      grid-template-rows: auto 1fr;
      transform: translate(-50%, -48%) scale(0.98);
      opacity: 0;
      transition: transform 220ms ease, opacity 220ms ease;
    }

    .fit-panel.open {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .fit-head {
      border-bottom: 1px solid var(--line);
      padding: 16px;
      display: grid;
      gap: 10px;
      background: linear-gradient(170deg, #ebf8f5 0%, #fff 65%);
    }

    .fit-head-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .fit-title {
      margin: 0;
      font-size: 1.02rem;
      letter-spacing: 0.01em;
    }

    .fit-close {
      min-width: 36px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fff;
      color: #121418;
      font-weight: 700;
    }

    .fit-sub {
      margin: 0;
      color: #3b4a46;
      font-size: 0.88rem;
      line-height: 1.45;
    }

    .fit-body {
      overflow: auto;
      padding: 16px;
      display: grid;
      gap: 14px;
      align-content: start;
      grid-template-columns: minmax(0, 1fr) 300px;
      align-items: stretch;
    }

    .fit-body > .result-card { grid-column: 1; }

    .fit-side {
      grid-column: 2;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-self: stretch;
      height: 100%;
      min-height: 100%;
    }

    .result-card {
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }

    .result-hero {
      aspect-ratio: 16 / 10;
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid var(--line);
      background: #f4f6f2;
    }

    .compare {
      position: absolute;
      inset: 0;
      cursor: default;
      user-select: none;
      touch-action: none;
    }

    .compare.show-generated {
      cursor: ew-resize;
    }

    .compare.show-slider {
      cursor: ew-resize;
    }

    .compare.is-disabled {
      cursor: default;
      filter: saturate(0.85);
    }

    .compare-layer {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      color: #34544d;
      font-weight: 700;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 10px;
    }

    .compare-base {
      background: linear-gradient(160deg, #e9e2d3 0%, #f9f7f1 45%, #dcebe5 100%);
    }

    .compare-base.upload-target {
      cursor: pointer;
      outline: 2px dashed rgba(17, 94, 89, 0.35);
      outline-offset: -14px;
      transition: background-color 180ms ease, outline-color 180ms ease;
    }

    .compare-base.upload-target.is-dragging {
      background-color: #e7f7f3;
      outline-color: rgba(15, 118, 110, 0.8);
    }

    .compare-base.upload-target.has-image {
      outline: none;
    }

    .compare-base.has-image {
      background-position: center;
      background-size: contain;
      background-repeat: no-repeat;
      background-color: #edf1ef;
    }

    .compare-generated {
      display: none;
      background: linear-gradient(160deg, #d5ece6 0%, #e8f8f4 45%, #fff2dc 100%);
      clip-path: inset(0 50% 0 0);
      border-right: 1px solid rgba(17, 94, 89, 0.45);
    }

    .compare.show-generated .compare-generated {
      display: grid;
    }

    .compare-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background: rgba(17, 94, 89, 0.7);
      pointer-events: none;
      opacity: 0;
      transition: opacity 180ms ease;
    }

    .compare.show-slider .compare-handle {
      opacity: 1;
    }

    .compare-handle::before {
      content: "< >";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 44px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(17, 94, 89, 0.28);
      background: rgba(255, 255, 255, 0.92);
      color: #155952;
      display: grid;
      place-items: center;
      font-size: 0.62rem;
      letter-spacing: 0.14em;
      font-weight: 800;
    }

    .result-copy {
      padding: 14px;
      display: grid;
      gap: 4px;
    }

    .result-copy p,
    .result-copy h3 { margin: 0; }

    .result-copy h3 {
      color: var(--muted);
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .size-result {
      font-size: 1.7rem;
      line-height: 1;
      letter-spacing: 0.02em;
    }

    .fit-metrics-side {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .metric {
      border: 1px solid #d9e4df;
      border-radius: 10px;
      background: #f8fcfb;
      min-height: 68px;
      padding: 10px;
      display: grid;
      gap: 4px;
      align-content: center;
    }

    .metric-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #60706a;
      font-weight: 700;
    }

    .metric-value {
      font-size: 1.14rem;
      color: #1c3430;
      font-weight: 700;
      line-height: 1.1;
    }

    #resultText:empty,
    #statusText:empty {
      display: none;
    }

    .fit-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: auto;
    }

    #startBtn,
    #buyBtn {
      grid-column: 1 / -1;
      width: 100%;
    }

    .fit-btn {
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: #12181b;
      font-size: 0.9rem;
      font-weight: 700;
      min-height: 56px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 14px;
    }

    .fit-btn.primary {
      border: 0;
      background: linear-gradient(140deg, var(--brand), var(--brand-dark));
      color: #fff;
      justify-content: center;
      gap: 10px;
    }

    .fit-btn-credit {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      min-height: 24px;
      border-radius: 999px;
      padding: 0 8px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .mini-controls {
      border: 1px dashed #c9d2cf;
      border-radius: 14px;
      padding: 12px;
      background: #fbfdfc;
      display: grid;
      gap: 8px;
    }

    .mini-controls p {
      margin: 0;
      color: var(--muted);
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .mini-row {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }

    .mini-row button {
      min-height: 38px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      font-size: 0.78rem;
    }

    .mini-row button.active {
      border-color: var(--brand);
      color: var(--brand);
      background: #ecf9f7;
      font-weight: 700;
    }

    @media (max-width: 1024px) {
      .desktop-shell {
        width: calc(100% - 24px);
        margin-top: 16px;
      }

      .site-header-inner {
        width: calc(100% - 24px);
      }

      .product-layout {
        grid-template-columns: 1fr;
      }

      .product-panel {
        position: static;
      }

      .fit-panel {
        width: calc(100vw - 24px);
        max-height: calc(100vh - 24px);
      }

      .fit-body {
        grid-template-columns: 1fr;
      }

      .fit-body > .result-card,
      .fit-side {
        grid-column: auto;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    @media (forced-colors: active) {
      button,
      .fit-backdrop,
      .fit-panel,
      .result-card,
      .fab-hint,
      .product-panel { border: 1px solid CanvasText; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="site-header-inner">
      <p class="logo">WearOn Shop</p>
      <nav class="nav" aria-label="Main">
        <span>Women</span>
        <span>Men</span>
        <span>New In</span>
        <span>Collections</span>
      </nav>
      <div class="header-actions">
        <button class="header-icon" type="button" aria-label="Search">S</button>
        <button class="header-icon" type="button" aria-label="Account">A</button>
        <button class="header-icon" type="button" aria-label="Cart">2</button>
      </div>
    </div>
  </header>

  <main class="desktop-shell" aria-label="Desktop product page mock">
    <div class="breadcrumbs" aria-label="Breadcrumb">
      <span>Home</span>
      <span>/</span>
      <span>Overshirts</span>
      <span>/</span>
      <span>Essential Cotton Overshirt</span>
    </div>

    <section class="product-layout">
      <div class="gallery">
        <div class="hero-image" role="img" aria-label="Desktop product image placeholder">
          Model + Garment
        </div>
        <div class="thumbs" aria-label="Product image thumbnails">
          <div class="thumb active" aria-hidden="true"></div>
          <div class="thumb" aria-hidden="true"></div>
          <div class="thumb" aria-hidden="true"></div>
          <div class="thumb" aria-hidden="true"></div>
          <div class="thumb" aria-hidden="true"></div>
        </div>
      </div>

      <aside class="product-panel" aria-label="Product details">
        <div>
          <p class="eyebrow">WearOn Studio</p>
          <h1 class="title">Essential Cotton Overshirt</h1>
        </div>

        <div class="price-row">
          <span class="price">$74.00</span>
          <span class="compare">$96.00</span>
          <span class="badge">23% Off</span>
        </div>

        <div>
          <p class="group-label">Color: Moss</p>
          <div class="swatches">
            <button class="swatch active" style="background:#5a7f6b" type="button" aria-label="Moss"></button>
            <button class="swatch" style="background:#1f2937" type="button" aria-label="Charcoal"></button>
            <button class="swatch" style="background:#d1c2a7" type="button" aria-label="Sand"></button>
            <button class="swatch" style="background:#7f5539" type="button" aria-label="Rust"></button>
          </div>
        </div>

        <div>
          <p class="group-label">Size</p>
          <div class="sizes">
            <button class="size" type="button">XS</button>
            <button class="size active" type="button">S</button>
            <button class="size" type="button">M</button>
            <button class="size" type="button">L</button>
            <button class="size" type="button">XL</button>
          </div>
        </div>

        <div class="ctas">
          <button class="cta primary" type="button">Add to Cart</button>
          <button class="cta secondary" type="button">Buy Now</button>
        </div>

        <div class="accordion" aria-label="Product details sections">
          <div class="accordion-item"><span>Description</span><span>+</span></div>
          <div class="accordion-item"><span>Shipping & Returns</span><span>+</span></div>
          <div class="accordion-item"><span>Care Instructions</span><span>+</span></div>
        </div>
      </aside>
    </section>
  </main>

  <button id="wearonFab" class="wearon-fab" type="button" aria-haspopup="dialog" aria-controls="fitPanel" aria-expanded="false">
    Fit
  </button>

  <aside id="fabHint" class="fab-hint" role="status" aria-live="polite" hidden>
    <div class="fab-hint-head">
      <p class="fab-hint-title">Try WearOn Fit</p>
      <button id="fabHintClose" class="fab-hint-close" type="button" aria-label="Dismiss hint">x</button>
    </div>
    <div class="fab-hint-image" role="img" aria-label="Try-on preview placeholder image">
      Try-on image placeholder
    </div>
    <p id="fabHintText" class="fab-hint-text"></p>
    <div class="fab-hint-actions">
      <button id="fabHintTry" class="fab-hint-try" type="button">Try Now</button>
      <button id="fabHintDismiss" class="fab-hint-dismiss" type="button">Later</button>
    </div>
  </aside>

  <div id="fitBackdrop" class="fit-backdrop" hidden></div>

  <section id="fitPanel" class="fit-panel" role="dialog" aria-modal="true" aria-label="WearOn fit assistant" hidden>
    <header class="fit-head">
      <div class="fit-head-row">
        <h2 class="fit-title">WearOn Fit Assistant</h2>
        <button id="fitClose" class="fit-close" type="button" aria-label="Close">x</button>
      </div>
      <p class="fit-sub">Desktop modal dialog with the same floating-entry flow as mobile.</p>
    </header>

    <div class="fit-body">
      <article class="result-card" aria-live="polite">
        <div id="resultHero" class="result-hero">
          <div id="compareRoot" class="compare" aria-label="Before and generated preview comparison" tabindex="0">
            <div
              id="compareBaseLayer"
              class="compare-layer compare-base upload-target"
              tabindex="0"
              role="button"
              aria-label="Drag and drop image here or click to upload"
            >Drag and drop image here or click to upload</div>
            <div id="compareGenLayer" class="compare-layer compare-generated">
              <span id="compareGenLabel">Generated try-on preview</span>
            </div>
            <div id="compareHandle" class="compare-handle" aria-hidden="true"></div>
          </div>
          <input id="uploadInput" type="file" accept="image/*" hidden />
        </div>
        <div class="result-copy">
          <h3>Recommended Size</h3>
          <p id="sizeText" class="size-result">M</p>
          <p id="resultText"></p>
          <p id="statusText"></p>
        </div>
      </article>

      <aside class="fit-side">
        <div class="fit-metrics-side">
          <div class="metric">
            <span class="metric-label">Fit Score</span>
            <span id="metricFit" class="metric-value">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confidence</span>
            <span id="metricConfidence" class="metric-value">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">Coverage</span>
            <span id="metricCoverage" class="metric-value">--</span>
          </div>
        </div>

        <div class="mini-controls">
          <p>Prototype Toggles</p>
          <div id="modeRow" class="mini-row">
            <button data-mode="absorb" class="active" type="button">Absorb</button>
            <button data-mode="resell" type="button">Resell</button>
            <button data-credits="0" type="button">0 Cr</button>
            <button data-credits="2" class="active" type="button">2 Cr</button>
          </div>
          <div id="stateRow" class="mini-row">
            <button data-state="base" class="active" type="button">Base</button>
            <button data-state="loading" type="button">Loading</button>
            <button data-state="result" type="button">Result</button>
            <button data-state="error" type="button">Error</button>
          </div>
        </div>

        <div class="fit-actions">
          <button id="startBtn" class="fit-btn primary" type="button">
            <span>Generate</span>
            <span class="fit-btn-credit">⚡ 2</span>
          </button>
          <button id="buyBtn" class="fit-btn" type="button">Top Up ⚡</button>
        </div>
      </aside>
    </div>
  </section>

  <script>
    const fab = document.getElementById('wearonFab');
    const hint = document.getElementById('fabHint');
    const hintText = document.getElementById('fabHintText');
    const hintClose = document.getElementById('fabHintClose');
    const hintTry = document.getElementById('fabHintTry');
    const hintDismiss = document.getElementById('fabHintDismiss');

    const panel = document.getElementById('fitPanel');
    const backdrop = document.getElementById('fitBackdrop');
    const panelClose = document.getElementById('fitClose');

    const startBtn = document.getElementById('startBtn');
    const buyBtn = document.getElementById('buyBtn');
    const uploadInput = document.getElementById('uploadInput');
    const resultHero = document.getElementById('resultHero');
    const compareRoot = document.getElementById('compareRoot');
    const compareBaseLayer = document.getElementById('compareBaseLayer');
    const compareGenLayer = document.getElementById('compareGenLayer');
    const compareHandle = document.getElementById('compareHandle');
    const compareGenLabel = document.getElementById('compareGenLabel');
    const sizeText = document.getElementById('sizeText');
    const metricFit = document.getElementById('metricFit');
    const metricConfidence = document.getElementById('metricConfidence');
    const metricCoverage = document.getElementById('metricCoverage');
    const resultText = document.getElementById('resultText');
    const statusText = document.getElementById('statusText');

    let mode = 'absorb';
    let credits = 2;
    let state = 'base';
    let lastRenderedState = state;
    let comparePercent = 50;
    let compareEnabled = true;
    let draggingCompare = false;
    let compareAnimationFrame = null;
    let uploadObjectUrl = null;

    const hintKey = 'wearon_fit_hint_seen_desktop_v1';
    const hintMessage = 'Tap Fit to preview sizing before you add to cart.';
    let hintTimer = null;

    function markActive(container, predicate) {
      container.querySelectorAll('button').forEach((button) => {
        button.classList.toggle('active', predicate(button));
      });
    }

    function hintSeen() {
      try {
        return window.sessionStorage.getItem(hintKey) === '1';
      } catch (_error) {
        return false;
      }
    }

    function setHintSeen() {
      try {
        window.sessionStorage.setItem(hintKey, '1');
      } catch (_error) {
        // Ignore storage failures.
      }
    }

    function typeHint(message) {
      clearInterval(hintTimer);
      hintText.textContent = '';
      let index = 0;
      hintTimer = setInterval(() => {
        index += 1;
        hintText.textContent = message.slice(0, index);
        if (index >= message.length) clearInterval(hintTimer);
      }, 20);
    }

    function showHint() {
      if (hintSeen()) return;
      hint.hidden = false;
      requestAnimationFrame(() => hint.classList.add('visible'));
      typeHint(hintMessage);
    }

    function hideHint(markSeen = true) {
      clearInterval(hintTimer);
      hint.classList.remove('visible');
      if (markSeen) setHintSeen();
      setTimeout(() => {
        if (!hint.classList.contains('visible')) hint.hidden = true;
      }, 180);
    }

    function openPanel() {
      hideHint();
      backdrop.hidden = false;
      panel.hidden = false;
      requestAnimationFrame(() => {
        backdrop.classList.add('open');
        panel.classList.add('open');
      });
      fab.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
      panelClose.focus();
    }

    function closePanel() {
      backdrop.classList.remove('open');
      panel.classList.remove('open');
      fab.setAttribute('aria-expanded', 'false');
      setTimeout(() => {
        if (!panel.classList.contains('open')) {
          panel.hidden = true;
          backdrop.hidden = true;
        }
      }, 220);
      document.body.style.overflow = '';
      fab.focus();
    }

    function stopCompareAnimation() {
      if (compareAnimationFrame !== null) {
        cancelAnimationFrame(compareAnimationFrame);
        compareAnimationFrame = null;
      }
    }

    function animateCompareTo(targetPercent, durationMs = 380) {
      stopCompareAnimation();
      const start = comparePercent;
      const end = Math.max(0, Math.min(100, Number(targetPercent) || 0));
      const delta = end - start;
      const startTime = performance.now();

      function step(now) {
        const t = Math.min((now - startTime) / durationMs, 1);
        const eased = 1 - Math.pow(1 - t, 3);
        setCompare(start + delta * eased);
        if (t < 1) {
          compareAnimationFrame = requestAnimationFrame(step);
        } else {
          compareAnimationFrame = null;
        }
      }

      compareAnimationFrame = requestAnimationFrame(step);
    }

    function setCompare(percent) {
      const normalized = Math.max(0, Math.min(100, Number(percent) || 0));
      comparePercent = normalized;
      compareGenLayer.style.clipPath = `inset(0 ${100 - normalized}% 0 0)`;
      compareHandle.style.left = `${normalized}%`;
    }

    function setCompareEnabled(enabled) {
      compareEnabled = enabled;
      compareRoot.classList.toggle('is-disabled', !enabled);
    }

    function setCompareGeneratedVisible(visible) {
      compareRoot.classList.toggle('show-generated', visible);
    }

    function setCompareSliderVisible(visible) {
      compareRoot.classList.toggle('show-slider', visible);
    }

    function pointerToPercent(clientX) {
      const rect = compareRoot.getBoundingClientRect();
      const raw = ((clientX - rect.left) / rect.width) * 100;
      return Math.max(0, Math.min(100, raw));
    }

    function setUploadedImage(file) {
      if (!file || !file.type.startsWith('image/')) {
        statusText.textContent = 'Please select an image file.';
        return;
      }

      if (uploadObjectUrl) URL.revokeObjectURL(uploadObjectUrl);
      uploadObjectUrl = URL.createObjectURL(file);

      compareBaseLayer.classList.add('has-image');
      compareBaseLayer.style.backgroundImage = `url("${uploadObjectUrl}")`;
      compareBaseLayer.textContent = '';
      statusText.textContent = `Uploaded: ${file.name}`;
    }

    function render() {
      const blocked = mode === 'resell' && credits === 0;

      startBtn.disabled = blocked || state === 'loading';
      buyBtn.style.display = mode === 'resell' ? 'block' : 'none';

      if (blocked) {
        startBtn.textContent = 'Top Up ⚡';
      } else {
        if (state === 'loading') {
          startBtn.textContent = 'Generating...';
        } else {
          startBtn.innerHTML = `<span>Generate</span><span class=\"fit-btn-credit\">⚡ ${credits}</span>`;
        }
      }

      if (state === 'base') {
        stopCompareAnimation();
        setCompare(0);
        setCompareGeneratedVisible(false);
        setCompareEnabled(false);
        setCompareSliderVisible(false);
        compareGenLabel.textContent = 'Generated try-on preview';
        sizeText.textContent = 'M';
        metricFit.textContent = '--';
        metricConfidence.textContent = '--';
        metricCoverage.textContent = '--';
        resultText.textContent = '';
        statusText.textContent = '';
      }

      if (state === 'loading') {
        stopCompareAnimation();
        setCompare(0);
        setCompareGeneratedVisible(false);
        setCompareEnabled(false);
        setCompareSliderVisible(false);
        compareGenLabel.textContent = 'Generating...';
        sizeText.textContent = '--';
        metricFit.textContent = '...';
        metricConfidence.textContent = '...';
        metricCoverage.textContent = '...';
        resultText.textContent = '';
        statusText.textContent = '';
      }

      if (state === 'result') {
        setCompareGeneratedVisible(true);
        setCompareEnabled(true);
        setCompareSliderVisible(true);
        if (lastRenderedState !== 'result') {
          animateCompareTo(50);
        }
        compareGenLabel.textContent = 'Generated try-on preview';
        sizeText.textContent = 'M';
        metricFit.textContent = '92%';
        metricConfidence.textContent = '88%';
        metricCoverage.textContent = '96%';
        resultText.textContent = '';
        statusText.textContent = '';
      }

      if (state === 'error') {
        stopCompareAnimation();
        setCompare(0);
        setCompareGeneratedVisible(false);
        setCompareEnabled(false);
        setCompareSliderVisible(false);
        compareGenLabel.textContent = 'Preview unavailable';
        sizeText.textContent = '--';
        metricFit.textContent = '--';
        metricConfidence.textContent = 'Low';
        metricCoverage.textContent = 'None';
        resultText.textContent = '';
        statusText.textContent = '';
      }

      lastRenderedState = state;
    }

    fab.addEventListener('click', openPanel);
    panelClose.addEventListener('click', closePanel);
    backdrop.addEventListener('click', closePanel);

    hintClose.addEventListener('click', () => hideHint());
    hintDismiss.addEventListener('click', () => hideHint());
    hintTry.addEventListener('click', () => {
      hideHint();
      openPanel();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !panel.hidden) closePanel();
    });

    document.getElementById('modeRow').addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;

      if (button.dataset.mode) mode = button.dataset.mode;
      if (button.dataset.credits) credits = Number(button.dataset.credits);

      markActive(document.getElementById('modeRow'), (b) => {
        if (b.dataset.mode) return b.dataset.mode === mode;
        if (b.dataset.credits) return Number(b.dataset.credits) === credits;
        return false;
      });

      render();
    });

    document.getElementById('stateRow').addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button || !button.dataset.state) return;

      state = button.dataset.state;
      markActive(document.getElementById('stateRow'), (b) => b.dataset.state === state);
      render();
    });

    startBtn.addEventListener('click', () => {
      state = 'loading';
      markActive(document.getElementById('stateRow'), (b) => b.dataset.state === state);
      render();

      setTimeout(() => {
        state = 'result';
        markActive(document.getElementById('stateRow'), (b) => b.dataset.state === state);
        render();
      }, 850);
    });

    buyBtn.addEventListener('click', () => {
      mode = 'resell';
      credits = 2;
      markActive(document.getElementById('modeRow'), (b) => {
        if (b.dataset.mode) return b.dataset.mode === mode;
        if (b.dataset.credits) return Number(b.dataset.credits) === credits;
        return false;
      });
      render();
    });

    uploadInput.addEventListener('change', () => {
      const [file] = uploadInput.files || [];
      if (!file) return;
      setUploadedImage(file);
    });

    ['dragenter', 'dragover'].forEach((eventName) => {
      compareBaseLayer.addEventListener(eventName, (event) => {
        event.preventDefault();
        compareBaseLayer.classList.add('is-dragging');
      });
    });

    ['dragleave', 'drop'].forEach((eventName) => {
      compareBaseLayer.addEventListener(eventName, (event) => {
        event.preventDefault();
        compareBaseLayer.classList.remove('is-dragging');
      });
    });

    compareBaseLayer.addEventListener('drop', (event) => {
      const [file] = event.dataTransfer?.files || [];
      if (!file) return;
      setUploadedImage(file);
    });

    compareBaseLayer.addEventListener('click', () => {
      uploadInput.click();
    });

    compareBaseLayer.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      event.preventDefault();
      uploadInput.click();
    });

    compareRoot.addEventListener('pointerdown', (event) => {
      if (!compareEnabled) return;
      stopCompareAnimation();
      draggingCompare = true;
      compareRoot.setPointerCapture(event.pointerId);
      setCompare(pointerToPercent(event.clientX));
    });

    compareRoot.addEventListener('pointermove', (event) => {
      if (!compareEnabled || !draggingCompare) return;
      setCompare(pointerToPercent(event.clientX));
    });

    compareRoot.addEventListener('pointerup', (event) => {
      draggingCompare = false;
      if (compareRoot.hasPointerCapture(event.pointerId)) {
        compareRoot.releasePointerCapture(event.pointerId);
      }
    });

    compareRoot.addEventListener('keydown', (event) => {
      if (!compareEnabled) return;
      if (event.key === 'ArrowLeft') {
        stopCompareAnimation();
        event.preventDefault();
        setCompare(comparePercent - 5);
      }
      if (event.key === 'ArrowRight') {
        stopCompareAnimation();
        event.preventDefault();
        setCompare(comparePercent + 5);
      }
    });

    render();
    setTimeout(showHint, 600);
  </script>
</body>
</html>
